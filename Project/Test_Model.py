from ProjectUtil import *
from Izhikevich import *
from Constants import *
import numpy as np

# ------------------------layer 1 dynamics-------------------------#

data, labels = data_load_mnist(DIGITS)
data = (data.T / (data.T).sum(axis=0)).T

inarr = []
tarr = []

start = data.shape[0] - 50
for index in range(start, start + NumOfDigits):
    print "Label : {0}".format(labels[index - start])
    ret = np.array(np.nonzero(data[index - start].reshape(28, 28))).T
    indicesArray = np.array(ret[:, 0])
    timeArray = np.array(ret[:, 1]) + ((index - start) * DIGIT_DURATION / ms)
    inarr.extend(indicesArray)
    tarr.extend(timeArray)

P1st = SpikeGeneratorGroup(M, inarr, tarr * ms)

# ------------------------layer 2 dynamics-------------------------#

P2nd = NeuronGroup(N/ K_VALUE, IzhikevichEquations, threshold=threshold, reset=reset)

# --------------------connecting layer 1 and layer 2-------------------#
syn12 = Synapses(P1st, P2nd, on_pre=Syn12Condition)

for x in range(0, K_VALUE):
    syn12.connect("i/K_VALUE==j")



# ------------------------layer 3/op dynamics-------------------------#


P3rd = NeuronGroup(NUM_OUTPUT_CLASSES, IzhikevichEquations, threshold=threshold, reset=reset)

syn23 = Synapses(P2nd, P3rd, '''w : 1
                        ''',
               on_pre='''I += 100 * w * volt/second
                        ''')


syn23.connect()

# syn23.w = [0.008, 0.008, 0.041, 0.028, 0.033, 0.070, 0.109, 0.137, 0.158, 0.155, 0.132, 0.105, 0.008, 0.008,
# 0.009, 0.010, 0.062, 0.147, 0.100, 0.034, 0.026, 0.051, 0.147, 0.190, 0.142, 0.063, 0.009, 0.009,
# 0.009, 0.009, 0.130, 0.190, 0.083, 0.045, 0.076, 0.062, 0.018, 0.026, 0.122, 0.186, 0.033, 0.010,
# 0.010, 0.010, 0.010, 0.028, 0.082, 0.138, 0.187, 0.208, 0.159, 0.055, 0.036, 0.038, 0.029, 0.010,
# 0.008, 0.008, 0.020, 0.065, 0.092, 0.117, 0.137, 0.152, 0.051, 0.105, 0.144, 0.088, 0.008, 0.008,
# 0.009, 0.033, 0.051, 0.043, 0.051, 0.071, 0.132, 0.165, 0.171, 0.151, 0.097, 0.011, 0.009, 0.009,
# 0.010, 0.010, 0.010, 0.079, 0.199, 0.114, 0.069, 0.045, 0.051, 0.044, 0.066, 0.091, 0.151, 0.063,
# 0.006, 0.006, 0.032, 0.084, 0.114, 0.127, 0.113, 0.055, 0.089, 0.113, 0.113, 0.112, 0.029, 0.006,
# 0.008, 0.008, 0.008, 0.059, 0.133, 0.154, 0.152, 0.155, 0.052, 0.027, 0.041, 0.072, 0.124, 0.008,
# 0.008, 0.008, 0.021, 0.047, 0.083, 0.092, 0.122, 0.126, 0.114, 0.146, 0.156, 0.061, 0.008, 0.008]

#syn23.w = [ 1.83606481, 1.03416515, 1.03180659, 1.03180002, 1.0318 , 1.0318 , 1.0318 , 1.0318 , 1.0318 , 1.0318 , 1.83276481, 1.03086515, 1.02850659, 1.04851821, 1.02855582, 1.02850016, 1.0285 , 1.06453128, 1.02860046, 1.02850028, 11.05633573, 1.10235201, 1.03613349, 1.09192227, 1.07798331, 1.00217427, 1.05076276, 1.09897228, 0.99728432, 1.07991354, 30.48572451, 1.18457116, 1.00412685, 1.17807888, 1.21994492, 1.05840517, 1.10503875, 1.01924334, 0.97211134, 1.19473062, 35.40088633, 1.2043063 , 0.98635986, 1.14620578, 1.14870716, 1.05230279, 1.14276333, 0.97208014, 1.15793419, 1.10130679, 31.11176877, 1.21226209, 1.00254198, 1.08092322, 1.04660394, 1.10258587, 1.05666484, 1.01884142, 1.19564282, 1.12289721, 25.25828602, 1.15916159, 0.99491419, 1.02606572, 1.11088126, 1.14388117, 1.02984138, 1.14496822, 1.09925877, 1.07760178, 22.32505366, 1.09565317, 0.97984497, 1.06643701, 1.11709559, 1.23214951, 1.05841272, 1.20109542, 1.02874465, 1.04340446, 21.45871203, 1.13613469, 0.99324185, 1.22055032, 1.0275903 , 1.18991297, 1.03626299, 1.18199802, 1.02374178, 1.06955113, 28.26973621, 1.13819713, 1.03782343, 1.27037951, 1.02289464, 1.04798382, 1.08366752, 1.19726139, 1.01782779, 1.0801844 , 41.32614477, 1.21945787, 0.9961476 , 1.18075172, 1.14753377, 0.96929198, 1.15514486, 1.13397995, 0.99750125, 1.07825459, 33.31947167, 1.20140452, 1.00933844, 1.0435108 , 1.18366155, 0.99633338, 1.06482975, 1.00640524, 1.01570052, 1.13554925, 6.24580223, 1.0377291 , 1.01296923, 1.02330612, 1.07047605, 1.01821702, 1.03253768, 1.01295475, 1.07197716, 1.06172787, 1.83546492, 1.03356516, 1.03120659, 1.03120002, 1.0312 , 1.0312 , 1.0312 , 1.0312 , 1.0400122 , 1.03122457]

#syn23.w = [ 0.18564648, 0.10566652, 0.10543066, 0.10543 , 0.10543 , 0.10543 , 0.10543 , 0.10543 , 0.10543 , 0.10543 , 0.18234648, 0.10236652, 0.10213066, 0.10413182, 0.10213558, 0.10213002, 0.10213 , 0.10573313, 0.10214005, 0.10213003, 0.1517625 , 0.0811652 , 0.07454335, 0.08012223, 0.07872833, 0.07114743, 0.07600628, 0.08082723, 0.07065843, 0.07892135, 0.09441232, 0.03295712, 0.01491268, 0.03230789, 0.03649449, 0.02034052, 0.02500388, 0.01642433, 0.01171113, 0.03397306, 0.08718389, 0.01576063, -0.00603401, 0.00995058, 0.01020072, 0.00056028, 0.00960633, -0.00746199, 0.01112342, 0.00546068, 0.09743331, 0.02681621, 0.0058442 , 0.01368232, 0.01025039, 0.01584859, 0.01125648, 0.00747414, 0.02515428, 0.01787972, 0.09832061, 0.02015616, 0.00373142, 0.00684657, 0.01532813, 0.01862812, 0.00722414, 0.01873682, 0.01416588, 0.01200018, 0.0955605 , 0.01461532, 0.0030345 , 0.0116937 , 0.01675956, 0.02826495, 0.01089127, 0.02515954, 0.00792446, 0.00939045, 0.09442607, 0.02352347, 0.00923419, 0.03196503, 0.01266903, 0.0289013 , 0.0135363 , 0.0281098 , 0.01228418, 0.01686511, 0.09247493, 0.02723971, 0.01720234, 0.04045795, 0.01570946, 0.01821838, 0.02178675, 0.03314614, 0.01520278, 0.02143844, 0.08876142, 0.03212579, 0.00979476, 0.02825517, 0.02493338, 0.0071092 , 0.02569449, 0.023578 , 0.00993012, 0.01800546, 0.12181302, 0.05813045, 0.03892384, 0.04234108, 0.05635615, 0.03762334, 0.04447297, 0.03863052, 0.03956005, 0.05154493, 0.17268476, 0.08901291, 0.08653692, 0.08757061, 0.09228761, 0.0870617 , 0.08849377, 0.08653548, 0.09243772, 0.09141279, 0.18504649, 0.10506652, 0.10483066, 0.10483 , 0.10483 , 0.10483 , 0.10483 , 0.10483 , 0.10571122, 0.10483246]

syn23.w = [ 2.5348545 , 1.03822392, 1.03381233, 1.03380003, 1.0338 , 1.0338 , 1.0338 , 1.0338 , 1.0338 , 1.0338 , 2.53155451, 1.03492392, 1.03051233, 1.06800462, 1.0306045 , 1.03050029, 1.0305 , 1.09793535, 1.03068802, 1.03050052, 2.51721623, 1.19626671, 1.07229158, 1.17680731, 1.15063607, 1.00866663, 1.09966613, 1.18995422, 0.99953239, 1.15425927, 2.5547336 , 1.4049174 , 4.05344624, 5.32553671, 1.4711382 , 1.16868645, 1.25596769, 1.0953924 , 1.00708756, 1.42395112, 2.7969405 , 1.46046027, 3.01770174, 3.29757851, 2.3332661 , 1.17582284, 1.34524115, 4.02625409, 1.37361493, 1.2675833 , 3.80777034, 1.46541621, 1.07274626, 1.21961161, 2.13210801, 1.26004263, 1.17410708, 4.1159651 , 1.43429324, 1.29806876, 4.88095612, 1.36727321, 1.05979231, 1.11814383, 1.27689156, 1.33865523, 1.12511863, 5.30725938, 1.25510356, 2.23852346, 2.76234265, 1.24758566, 1.03077472, 1.19292971, 5.32152498, 1.50311735, 1.17781718, 1.4450783 , 1.122233 , 1.14974452, 3.64260205, 1.31865268, 4.12905279, 1.47694157, 4.14855582, 1.4193351 , 1.13163601, 1.40459363, 1.10815028, 1.1939868 , 4.55186055, 1.31911128, 7.25101659, 1.56689435, 1.10323089, 3.18015318, 1.21704162, 1.42978199, 1.09372329, 1.21050194, 5.52357541, 1.47441064, 4.10129465, 5.31373916, 1.33978077, 3.03001124, 1.35399658, 1.31444324, 1.05884621, 1.21002267, 5.60021604, 1.41372832, 2.06603299, 10.01937466, 1.38044225, 2.03572318, 1.15795693, 1.04857368, 2.07201249, 1.29034328, 2.6271615 , 1.06141049, 1.01502968, 2.04045522, 1.12272279, 1.02486141, 1.05166763, 1.01500252, 1.12553981, 1.10635458, 2.53425463, 1.03762392, 1.03321233, 1.03320003, 1.0332 , 1.0332 , 1.0332 , 1.0332 , 1.04970988, 1.03324603]

v_mon = getStateMonitor(P3rd)['voltage']
isyn_mon = getStateMonitor(P3rd)['current']
s_mon = getSpikeMonitor(P3rd)

run(DIGIT_DURATION*NumOfDigits)

print "Test Error  : {0}".format(getError(s_mon, labels))
figure(figsize=(6,4))
plot(s_mon.t/ms, s_mon.i, '.k')
xlabel('Time (ms)')
ylabel('Neuron index')
ylim([-1,len(P1st)+1])
tight_layout()

figure(figsize=(9, 9))
ax = axes()

ax2 = ax.twinx()
ax2.plot(isyn_mon.t / ms, isyn_mon.I[0], 'b', linewidth=3, alpha=.4)
ax2.set_xlabel('Time (ms)')
ax2.set_ylabel('Synaptic Current')
tight_layout()
show()